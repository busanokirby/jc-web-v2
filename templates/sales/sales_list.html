{% extends 'layouts/base.html' %}

{% block title %}Sales History - JC Icons{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center gap-3">
    <h1 class="m-0">
      <i class="bi bi-receipt"></i>
      {% if credits_only %}Credit Claims{% else %}Sales History{% endif %}
    </h1>

    <form id="sales-filter-form" class="d-flex" method="get" action="{{ url_for('sales.sales_list') }}" style="min-width:360px;">
      <input id="sales-search" type="search" name="q"
             class="form-control form-control-sm me-2"
             placeholder="Search invoice, ticket, SKU, product, customer, service"
             value="{{ q or '' }}">

      <select id="sales-status" name="status"
              class="form-select form-select-sm me-2"
              style="width:140px;"
              data-auto-submit="true">
        <option value="">All statuses</option>
        <option value="PAID" {% if request.args.get('status') == 'PAID' %}selected{% endif %}>Paid</option>
        <option value="PARTIAL" {% if request.args.get('status') == 'PARTIAL' %}selected{% endif %}>Partial</option>
        <option value="VOID" {% if request.args.get('status') == 'VOID' %}selected{% endif %}>Void</option>
      </select>

      <input id="sales-date-from" type="date" name="date_from"
             class="form-control form-control-sm me-2"
             value="{{ request.args.get('date_from', '') }}"
             style="max-width:140px;"
             data-auto-submit="true">

      <input id="sales-date-to" type="date" name="date_to"
             class="form-control form-control-sm me-2"
             value="{{ request.args.get('date_to', '') }}"
             style="max-width:140px;"
             data-auto-submit="true">

      <button class="btn btn-sm btn-outline-secondary me-2" type="submit">Search</button>

      {% if q or request.args.get('status') or request.args.get('date_from') or request.args.get('date_to') %}
        <a href="{{ url_for('sales.sales_list') }}" class="btn btn-sm btn-outline-light">Clear</a>
      {% endif %}
    </form>
  </div>

  <div class="d-flex align-items-center gap-2">
    <a href="{{ url_for('sales.credits') }}" class="btn btn-outline-warning">
      <i class="bi bi-wallet2"></i> Credits
      <span class="badge bg-warning text-dark ms-2">{{ credits_count or 0 }}</span>
    </a>

    <a href="{{ url_for('sales.pos') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> New Sale
    </a>
  </div>
</div>

{% if history and history.total > 0 %}
  {% if credits_only %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center">
      <div>
        <strong>Credits outstanding:</strong>
        <span class="ms-2">₱{{ "%.2f"|format(credits_total or 0) }}</span>
        <span class="text-muted ms-3">({{ credits_count or 0 }} items)</span>
      </div>
      <div>
        <a href="{{ url_for('sales.sales_list') }}" class="btn btn-sm btn-outline-secondary">Back to Sales</a>
      </div>
    </div>
  {% endif %}

  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Invoice / Ticket</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Balance Due</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for entry in history.items %}
          <tr>
            <td>
              <strong>{{ entry.invoice }}</strong>
              <br><small class="text-muted">{{ entry.type|capitalize }}</small>
            </td>

            <td>
              {% if entry.customer_name %}
                <strong>{{ entry.customer_name }}</strong>
                {% if entry.customer_business %}
                  <br><small class="text-muted">{{ entry.customer_business }}</small>
                {% endif %}
              {% else %}
                <span class="text-muted">Walk-in</span>
              {% endif %}
            </td>

            <td>{{ entry.created_at.strftime('%Y-%m-%d %H:%M') if entry.created_at else '' }}</td>

            <td>
              <span class="badge bg-info">{{ entry.items_count }}</span>
            </td>

            <td>
              <strong>₱{{ "%.2f"|format(entry.total) }}</strong>
            </td>

            <td>
              {# Use unified status_display which merges partial + credit #}
              {% set sdisp = entry.status_display if entry.status_display is defined else (entry.status or '') %}
              <span class="badge
                {% if sdisp == 'PAID' %}bg-success
                {% elif 'PARTIAL' in sdisp or 'CREDIT' in sdisp %}bg-warning
                {% elif sdisp == 'VOID' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ sdisp }}
              </span>
            </td>

            <td>
              {% if entry.balance_due and entry.balance_due > 0 %}
                <span class="text-danger fw-bold">₱{{ "%.2f"|format(entry.balance_due) }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if entry.type == 'sale' %}
                {# View Invoice #}
                <a href="{{ url_for('sales.invoice', sale_id=entry.id) }}"
                   class="btn btn-sm btn-outline-primary"
                   title="View Invoice">
                  <i class="bi bi-file-earmark-pdf"></i>
                </a>

                {# ✅ Always go to modal for any sale with balance due (safe: no accidents) #}
                {% if entry.balance_due and entry.balance_due > 0 %}
                  <button type="button"
                          class="btn btn-sm btn-success ms-1"
                          title="Record payment"
                          data-bs-toggle="modal"
                          data-bs-target="#salePaymentModal"
                          data-sale-id="{{ entry.id }}"
                          data-invoice="{{ entry.invoice }}"
                          data-balance="{{ entry.balance_due }}"
                          data-customer="{{ entry.customer_name or 'Walk-in' }}">
                    <i class="bi bi-cash-stack"></i>
                  </button>
                {% endif %}

                {% if current_user.role == 'ADMIN' %}
                  <form method="POST"
                        action="{{ url_for('sales.delete_sale', sale_id=entry.id) }}"
                        style="display:inline; margin-left:6px;">
                    <button type="submit"
                            class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Delete this sale? This will restore stock for sold items.');"
                            title="Delete Sale">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                {% endif %}

              {% else %}
                {# View Repair Receipt #}
                <a href="{{ url_for('repairs.print_receipt', device_id=entry.id) }}"
                   class="btn btn-sm btn-outline-primary"
                   title="View Repair Receipt">
                  <i class="bi bi-file-earmark-pdf"></i>
                </a>

                {# ✅ Repairs: NO full payment button here.
                   Show ONE payment button whenever repair needs payment,
                   and redirect to repair detail to process payment there.
                #}
                {% set needs_repair_payment =
                      (entry.balance_due|default(0) > 0)
                      or (entry.claimed_on_credit|default(false))
                      or ('PARTIAL' in (entry.status_display|default(entry.status|default(''))|upper))
                %}

                {% if needs_repair_payment %}
                  <a href="{{ url_for('repairs.repair_detail', device_id=entry.id) }}"
                     class="btn btn-sm btn-success ms-1"
                     title="Proceed to repair to process payment">
                    <i class="bi bi-cash-stack"></i>
                  </a>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Pagination for unified history #}
    {% set pagination = history %}
    {% include 'layouts/pagination.html' %}
  </div>
{% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    {% if credits_only %}
      No credit claims found.
    {% else %}
      No sales or repair-part records found.
      <a href="{{ url_for('sales.pos') }}" class="alert-link">Create your first sale</a>
      <a href="{{ url_for('repairs.add_repair') }}" class="alert-link ms-3">Create a repair ticket</a>
    {% endif %}
  </div>
{% endif %}

<style>
  tbody tr { transition: background-color 0.15s ease-in-out; }
  tbody tr:hover { background-color: #f8f9fa; }
</style>

<!-- ✅ Sale Payment Modal (Sales only) -->
<div class="modal fade" id="salePaymentModal" tabindex="-1" aria-labelledby="salePaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="salePaymentForm" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="salePaymentModalLabel">Record Sale Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="small text-muted mb-3">
            Invoice: <span id="spInvoice"></span><br>
            Customer: <span id="spCustomer"></span><br>
            Balance Due: ₱<span id="spBalance"></span>
          </div>

          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input type="number"
                   class="form-control"
                   id="paymentAmount"
                   name="amount"
                   min="0.01"
                   step="0.01"
                   required>
            <div class="form-text">
              Starts blank to avoid accidents. Max is the current balance.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Payment Method</label>
            <select class="form-select" name="payment_method" id="paymentMethod">
              <option value="Cash">Cash</option>
              <option value="GCash">GCash</option>
              <option value="Card">Card</option>
              <option value="Bank">Bank</option>
            </select>
          </div>

          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnPayHalf">50%</button>
            <button type="button" class="btn btn-outline-warning btn-sm" id="btnPayFull">Fill Full Balance</button>
          </div>

          {# If you use CSRF tokens (Flask-WTF), place token INSIDE form (uncomment if applicable): #}
          {# {{ csrf_token() }} #}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Payment</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-submit sales filter form when status/date changes
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('sales-filter-form');
    const autoSubmitElements = document.querySelectorAll('#sales-filter-form [data-auto-submit="true"]');

    if (!form) return;

    autoSubmitElements.forEach(element => {
      element.addEventListener('change', function() {
        clearTimeout(window.salesFilterTimeout);
        window.salesFilterTimeout = setTimeout(() => form.submit(), 200);
      });
    });

    const searchInput = document.getElementById('sales-search');
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          form.submit();
        }
      });
    }
  });

  // Sale payment modal logic (Sales only)
  document.addEventListener('DOMContentLoaded', function () {
    const modalEl = document.getElementById('salePaymentModal');
    const form = document.getElementById('salePaymentForm');
    const amountInput = document.getElementById('paymentAmount');

    if (!modalEl || !form || !amountInput) return;

    const spInvoice = document.getElementById('spInvoice');
    const spCustomer = document.getElementById('spCustomer');
    const spBalance = document.getElementById('spBalance');
    const btnHalf = document.getElementById('btnPayHalf');
    const btnFull = document.getElementById('btnPayFull');

    // Template URL: /sales/0/payment -> replace 0 with real sale_id
    const actionTemplate = "{{ url_for('sales.add_payment_for_sale', sale_id=0) }}";

    modalEl.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;

      const saleId = button.getAttribute('data-sale-id');
      const invoice = button.getAttribute('data-invoice') || '';
      const customer = button.getAttribute('data-customer') || 'Walk-in';
      const balance = parseFloat(button.getAttribute('data-balance') || '0');

      spInvoice.textContent = invoice;
      spCustomer.textContent = customer;
      spBalance.textContent = balance.toFixed(2);

      // /sales/0/payment -> /sales/<saleId>/payment
      form.action = actionTemplate.replace('/0/', '/' + saleId + '/');

      // Safety: start blank (no accidental full payment)
      amountInput.max = balance.toFixed(2);
      amountInput.value = '';
      setTimeout(() => amountInput.focus(), 50);

      if (btnHalf) btnHalf.onclick = () => amountInput.value = (balance / 2).toFixed(2);
      if (btnFull) btnFull.onclick = () => amountInput.value = balance.toFixed(2);
    });

    // Client-side guard (server also validates)
    form.addEventListener('submit', function (e) {
      const max = parseFloat(amountInput.max || '0');
      const val = parseFloat(amountInput.value || '0');

      if (val <= 0) {
        e.preventDefault();
        alert("Amount must be greater than 0.");
        return;
      }
      if (val > max + 0.0001) {
        e.preventDefault();
        alert("Amount cannot exceed the remaining balance.");
        return;
      }
    });
  });
</script>
{% endblock %}