{% extends 'layouts/base.html' %}

{% block title %}Point of Sale - JC Icons{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-cart-check"></i> Point of Sale System</h1>
    <div>
        <a href="{{ url_for('sales.sales_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> Sales History
        </a>
        <a href="{{ url_for('sales.reports') }}" class="btn btn-outline-info">
            <i class="bi bi-graph-up"></i> Reports
        </a>
    </div>
</div>

<div class="row">
    <!-- Products Section -->
    <div class="col-md-8">
        <!-- Customer Section -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-person"></i> Customer (Optional)</h5>
            </div>
            <div class="card-body">
                <label class="form-label">Search and select a customer for this sale</label>
                <div class="input-group mb-2">
                    <input type="text" id="customer-search-input" class="form-control" placeholder="Type customer name or phone..." autocomplete="off">
                    <button type="button" class="btn btn-outline-secondary" id="customer-search-btn">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <!-- Search results dropdown -->
                <div id="customer-search-results" class="list-group" style="max-height: 200px; overflow-y: auto; display: none;">
                    <!-- Results populated by JS -->
                </div>
                
                <select id="customer-select" class="form-select" style="display: none;">
                    <option value="">-- Walk-in Customer --</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone }})</option>
                    {% endfor %}
                </select>
                
                <div id="selected-customer" class="alert alert-info mt-2" style="display: none;">
                    Selected: <strong id="selected-customer-name"></strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="clear-customer-btn">Clear</button>
                </div>

                <hr>
                <button type="button" class="btn btn-outline-primary w-100" id="add-customer-btn" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                    <i class="bi bi-plus-circle"></i> Add New Customer
                </button>
                <small class="text-muted d-block mt-2">Customer is optional. Select one to associate the sale with their account.</small>
            </div>
        </div>

        <!-- Products Section -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Add Products</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Search for a product</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="product-search-input" placeholder="Type product name or SKU..." autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="product-search-btn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <!-- Search results dropdown -->
                    <div id="product-search-results" class="list-group mt-2" style="max-height: 250px; overflow-y: auto; display: none;">
                        <!-- Results populated by JS -->
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Or select from the list below</label>
                    <select id="product-select" class="form-select">
                        <option value="">-- Choose a product --</option>
                        {% for p in products %}
                        <option value="{{ p.id }}" 
                                data-name="{{ p.name }}" 
                                data-price="{{ p.sell_price }}" 
                                data-stock="{{ p.stock_on_hand }}"
                                data-is-service="{{ p.is_service }}">
                            {% if not p.is_service %}
                                {{ p.name }} (Stock: {{ p.stock_on_hand }}) - ₱{{ "%.2f"|format(p.sell_price) }}
                            {% else %}
                                {{ p.name }} (Service) - ₱{{ "%.2f"|format(p.sell_price) }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="product-qty" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-primary w-100" id="add-to-cart-btn">
                            <i class="bi bi-plus-circle"></i> Add to Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Section -->
    <div class="col-md-4">
        <div class="card sticky-top">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cart"></i> Shopping Cart</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="cart-items">
                    <p class="text-muted text-center py-4">Your cart is empty</p>
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="mb-3">
                    <div class="row mb-2">
                        <div class="col-6"><strong>Subtotal:</strong></div>
                        <div class="col-6 text-end"><span id="subtotal" class="h6">₱0.00</span></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><label class="form-label mb-0">Discount:</label></div>
                        <div class="col-6">
                            <input type="number" id="discount-input" class="form-control form-control-sm" value="0" min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Total:</strong></div>
                        <div class="col-6 text-end"><h5 class="mb-0" id="total">₱0.00</h5></div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label small">Payment Method</label>
                        </div>
                        <div class="col-6">
                            <select id="payment-method" class="form-select form-select-sm">
                                <option value="Cash">Cash</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Check">Check</option>
                                <option value="Mobile Money">Mobile Money</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="apply-as-deposit-pos" checked>
                        <label class="form-check-label small" for="apply-as-deposit-pos">Apply payment as deposit (leave checked to record deposit)</label>
                    </div>
                </div>

                <form id="checkout-form" method="POST" style="display: none;">
                    <input type="hidden" id="items-input" name="items">
                    <input type="hidden" id="customer-input" name="customer_id">
                    <input type="hidden" id="discount-input-hidden" name="discount">
                    <input type="hidden" id="payment-method-input" name="payment_method">
                    <input type="hidden" id="apply-as-deposit-input" name="apply_as_deposit" value="yes">
                </form>

                <button type="button" id="checkout-btn" class="btn btn-success w-100 btn-lg" disabled>
                    <i class="bi bi-check-circle"></i> Complete Sale
                </button>
                <button type="button" id="clear-cart-btn" class="btn btn-outline-danger w-100 mt-2">
                    <i class="bi bi-trash"></i> Clear Cart
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script id="products-data" type="application/json">
{{ products | tojson }}
</script>
<script>
let cart = [];
const products = JSON.parse(document.getElementById('products-data').textContent);
let productSelect, productQty, addBtn, checkoutBtn, clearBtn, discountInput, paymentMethodSelect, 
    searchInput, searchBtn, searchResults, customerSelect;

// Global functions for inline onclick handlers
window.removeFromCart = function(idx) {
    cart.splice(idx, 1);
    updateCart();
};

window.updateQty = function(idx, qty) {
    const q = parseInt(qty);
    if (q > 0) {
        cart[idx].qty = q;
        updateCart();
    }
};

window.updatePrice = function(idx, price) {
    const p = parseFloat(price);
    if (!isNaN(p) && p >= 0) {
        cart[idx].price = p;
        updateCart();
    }
};

window.selectFromSearch = function(productId, name, price, stock, isService) {
    productSelect.value = productId;
    searchInput.value = name;
    searchResults.style.display = 'none';
    productQty.focus();
    productQty.select();
};

function updateCart() {
    const cartItemsEl = document.getElementById('cart-items');
    
    if (cart.length === 0) {
        cartItemsEl.innerHTML = '<p class="text-muted text-center py-4">Your cart is empty</p>';
        checkoutBtn.disabled = true;
    } else {
        cartItemsEl.innerHTML = cart.map((item, idx) => `
            <div class="card mb-2">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <strong class="small">${item.product_name}</strong>
                            <div class="small text-muted">₱${item.price.toFixed(2)} × ${item.qty}</div>
                        </div>
                        <div class="text-end">
                            <div class="small"><strong>₱${(item.price * item.qty).toFixed(2)}</strong></div>
                            <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeFromCart(${idx})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 row g-1">
                        <div class="col-6">
                            <label class="form-text small text-muted">Qty</label>
                            <input type="number" class="form-control form-control-sm" value="${item.qty}" min="1" onchange="updateQty(${idx}, this.value)" placeholder="Qty">
                        </div>
                        <div class="col-6">
                            <label class="form-text small text-muted">Price</label>
                            <input type="number" class="form-control form-control-sm" value="${item.price.toFixed(2)}" step="0.01" min="0" onchange="updatePrice(${idx}, this.value)" placeholder="Price">
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        checkoutBtn.disabled = false;
    }

    // Calculate totals
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    const discount = parseFloat(discountInput.value) || 0;
    const total = Math.max(0, subtotal - discount);

    document.getElementById('subtotal').textContent = '₱' + subtotal.toFixed(2);
    document.getElementById('total').textContent = '₱' + total.toFixed(2);
}

document.addEventListener('DOMContentLoaded', function(){
    productSelect = document.getElementById('product-select');
    productQty = document.getElementById('product-qty');
    addBtn = document.getElementById('add-to-cart-btn');
    checkoutBtn = document.getElementById('checkout-btn');
    clearBtn = document.getElementById('clear-cart-btn');
    discountInput = document.getElementById('discount-input');
    paymentMethodSelect = document.getElementById('payment-method');
    searchInput = document.getElementById('product-search-input');
    searchBtn = document.getElementById('product-search-btn');
    searchResults = document.getElementById('product-search-results');
    customerSelect = document.getElementById('customer-select');

    // Product selection
    productSelect.addEventListener('change', function(){
        if (this.value) {
            productQty.focus();
        }
    });

    // Add to cart
    addBtn.addEventListener('click', function(){
        const productId = parseInt(productSelect.value);
        const qty = parseInt(productQty.value);

        if (!productId) {
            alert('Please select a product');
            return;
        }

        if (qty <= 0) {
            alert('Please enter a quantity greater than 0');
            return;
        }

        const product = products.find(p => p.id === productId);
        if (!product) return;

        if (!product.is_service && qty > product.stock_on_hand) {
            alert(`Not enough stock. Available: ${product.stock_on_hand}`);
            return;
        }

        // Use product's sell_price directly
        const price = product.sell_price;

        // Check if already in cart with same price
        const existing = cart.find(item => item.product_id === productId && item.price === price);
        if (existing) {
            existing.qty += qty;
        } else {
            cart.push({
                product_id: productId,
                product_name: product.name,
                price: price,
                qty: qty
            });
        }

        // Reset and refresh
        productSelect.value = '';
        productQty.value = '1';
        searchInput.value = '';
        updateCart();
    });

    // Search functionality
    searchInput.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        if (q.length < 1) {
            searchResults.style.display = 'none';
            return;
        }

        const results = products.filter(p => p.name.toLowerCase().includes(q) || (p.sku && p.sku.toLowerCase().includes(q)));
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="list-group-item">No products found</div>';
            searchResults.style.display = 'block';
            return;
        }

        searchResults.innerHTML = results.map(p => `
            <button type="button" class="list-group-item list-group-item-action" onclick="selectFromSearch(${p.id}, '${p.name}', ${p.sell_price}, ${p.stock_on_hand}, ${p.is_service})">
                <div class="d-flex justify-content-between">
                    <strong>${p.name}</strong>
                    <span class="text-muted">₱${p.sell_price.toFixed(2)}</span>
                </div>
                <small class="text-muted">${p.is_service ? 'Service' : 'Stock: ' + p.stock_on_hand}</small>
            </button>
        `).join('');
        searchResults.style.display = 'block';
    });

    searchBtn.addEventListener('click', function(){
        const q = searchInput.value.trim().toLowerCase();
        if (q.length < 1) return;
        const results = products.filter(p => p.name.toLowerCase().includes(q) || (p.sku && p.sku.toLowerCase().includes(q)));
        if (results.length > 0) {
            selectFromSearch(results[0].id, results[0].name, results[0].sell_price, results[0].stock_on_hand, results[0].is_service);
        }
    });

    // Clear cart
    clearBtn.addEventListener('click', function(){
        if (confirm('Are you sure you want to clear the cart?')) {
            cart = [];
            updateCart();
        }
    });

    // Checkout
    checkoutBtn.addEventListener('click', function(){
        if (cart.length === 0) {
            alert('Your cart is empty. Please add items before checking out.');
            return;
        }

        document.getElementById('items-input').value = JSON.stringify(cart);
        document.getElementById('customer-input').value = customerSelect.value || '';
        document.getElementById('discount-input-hidden').value = discountInput.value;
        document.getElementById('payment-method-input').value = paymentMethodSelect.value;
        // include apply_as_deposit flag
        const applyDepositCheckbox = document.getElementById('apply-as-deposit-pos');
        document.getElementById('apply-as-deposit-input').value = (applyDepositCheckbox && applyDepositCheckbox.checked) ? 'yes' : 'no';

        document.getElementById('checkout-form').submit();
    });

    // Discount changes
    discountInput.addEventListener('change', updateCart);
    discountInput.addEventListener('input', updateCart);

    // Enter key support
    productQty.addEventListener('keypress', function(e){
        if (e.key === 'Enter') addBtn.click();
    });

    // Customer search functionality
    const customerSearchInput = document.getElementById('customer-search-input');
    const customerSearchBtn = document.getElementById('customer-search-btn');
    const customerSearchResults = document.getElementById('customer-search-results');
    const selectedCustomerDiv = document.getElementById('selected-customer');
    const selectedCustomerName = document.getElementById('selected-customer-name');
    const clearCustomerBtn = document.getElementById('clear-customer-btn');
    const addCustomerBtn = document.getElementById('add-customer-btn');

    customerSearchInput.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        if (q.length < 1) {
            customerSearchResults.style.display = 'none';
            return;
        }

        const options = Array.from(customerSelect.options).filter(opt => 
            opt.value && (opt.text.toLowerCase().includes(q))
        );

        if (options.length === 0) {
            customerSearchResults.innerHTML = '<div class="list-group-item">No customers found</div>';
            customerSearchResults.style.display = 'block';
            return;
        }

        customerSearchResults.innerHTML = options.map(opt => `
            <button type="button" class="list-group-item list-group-item-action" onclick="selectCustomer('${opt.value}', '${opt.text}')">
                ${opt.text}
            </button>
        `).join('');
        customerSearchResults.style.display = 'block';
    });

    clearCustomerBtn.addEventListener('click', function(){
        customerSelect.value = '';
        selectedCustomerDiv.style.display = 'none';
        customerSearchInput.value = '';
    });

    window.selectCustomer = function(customerId, customerName){
        customerSelect.value = customerId;
        selectedCustomerName.textContent = customerName;
        selectedCustomerDiv.style.display = 'block';
        customerSearchResults.style.display = 'none';
        customerSearchInput.value = '';
    };

    // Handle add customer form submission
    const addCustomerForm = document.getElementById('add-customer-form');
    const addCustomerModal = document.getElementById('addCustomerModal');
    const modalInstance = new bootstrap.Modal(addCustomerModal);

    addCustomerForm.addEventListener('submit', function(e){
        e.preventDefault();

        const formData = new FormData(this);
        fetch('{{ url_for("customers.add_customer") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new customer to the select dropdown
                const newOption = document.createElement('option');
                newOption.value = data.customer.id;
                newOption.text = `${data.customer.name} (${data.customer.phone})`;
                customerSelect.appendChild(newOption);

                // Select the new customer
                selectCustomer(data.customer.id, newOption.text);

                // Close the modal and reset the form
                modalInstance.hide();
                addCustomerForm.reset();
                alert('Customer added successfully!');
            } else {
                alert('Error adding customer: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(err => {
            alert('Error adding customer: ' + err);
        });
    });
});

function toggleModalPhoneRequirement() {
    const skipPhoneCheckbox = document.getElementById('modal-skip-phone');
    const phoneInput = document.getElementById('modal-customer-phone');
    
    if (skipPhoneCheckbox.checked) {
        phoneInput.required = false;
        phoneInput.disabled = true;
        phoneInput.value = '';
    } else {
        phoneInput.required = true;
        phoneInput.disabled = false;
    }
}
</script>

<!-- Modal for Adding New Customer -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCustomerLabel">Add New Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="add-customer-form">
        <div class="modal-body">
          <div class="mb-3">
            <label for="modal-customer-name" class="form-label">Full Name *</label>
            <input type="text" class="form-control" id="modal-customer-name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="modal-customer-phone" class="form-label">Phone Number *</label>
            <input type="tel" class="form-control" id="modal-customer-phone" name="phone" pattern="[0-9]{11}" placeholder="Enter 11-digit number" required>
            <small class="text-muted">11 digits required</small>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="modal-skip-phone" name="skip_phone" value="yes" onchange="toggleModalPhoneRequirement()">
              <label class="form-check-label" for="modal-skip-phone">
                Skip phone number entry
              </label>
            </div>
          </div>
          <div class="mb-3">
            <label for="modal-customer-email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="modal-customer-email" name="email">
          </div>
          <div class="mb-3">
            <label for="modal-customer-address" class="form-label">Address</label>
            <textarea class="form-control" id="modal-customer-address" name="address" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Customer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
