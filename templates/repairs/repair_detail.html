{% extends "layouts/base.html" %}

{% block title %}{{ device.ticket_number }} - Repair Detail - JC Icons{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-2">
                <i class="bi bi-tools"></i> Repair Ticket #{{ device.ticket_number }}
            </h1>
            <p class="text-muted mb-0">
                <strong>Customer:</strong> {{ device.owner.name }}<br>
                <strong>Phone:</strong> {{ device.owner.phone }}<br>
                <strong>Days in Shop:</strong> <span class="badge bg-warning">{{ days_in_shop }} days</span>
            </p>
        </div>
        <div class="text-end">
            <span class="badge bg-secondary me-2">{{ device.status }}</span>
            {% if device.priority == 'Emergency' %}
                <span class="badge bg-danger">{{ device.priority }} Priority</span>
            {% elif device.priority == 'High' %}
                <span class="badge bg-warning text-dark">{{ device.priority }} Priority</span>
            {% elif device.priority == 'Normal' %}
                <span class="badge bg-info">{{ device.priority }} Priority</span>
            {% else %}
                <span class="badge bg-success">{{ device.priority }} Priority</span>
            {% endif %}
        </div>
    </div>

    <div class="btn-group" role="group">
        <a href="{{ url_for('repairs.repairs') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Repairs
        </a>
        <a href="{{ url_for('repairs.print_ticket', device_id=device.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-printer"></i> Print Ticket
        </a>
        {% if device.payment_status != 'Pending' %}
        <a href="{{ url_for('repairs.print_receipt', device_id=device.id) }}" class="btn btn-outline-success" target="_blank">
            <i class="bi bi-receipt"></i> Print Receipt
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Device Information -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-laptop"></i> Device Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Device Type:</strong> {{ device.device_type|title }}<br>
                        <strong>Brand:</strong> {{ device.brand or 'N/A' }}<br>
                        <strong>Model:</strong> {{ device.model or 'N/A' }}<br>
                        <strong>Serial Number:</strong> {{ device.serial_number or 'N/A' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Issue:</strong> {{ device.issue_description }}<br>
                        <strong>Symptoms:</strong> {{ device.symptoms or 'None' }}<br>
                        <strong>Device Age:</strong> {{ device.device_age or 'Not specified' }}<br>
                        <strong>Warranty:</strong> {% if device.is_warranty_repair == 'yes' %}Yes{% elif device.is_warranty_repair == 'unsure' %}Unsure{% else %}No{% endif %}
                    </div>
                </div>
                {% if device.accessories %}
                <div class="mb-2">
                    <strong>Accessories:</strong><br>
                    <span class="text-muted">{{ device.accessories }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Status & Notes Update -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Update Repair Status</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('repairs.update_status', device_id=device.id) }}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">Current Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="Received" {% if device.status == 'Received' %}selected{% endif %}>Received - Initial intake</option>
                                <option value="Diagnosing" {% if device.status == 'Diagnosing' %}selected{% endif %}>Diagnosing - Testing in progress</option>
                                <option value="Repairing" {% if device.status == 'Repairing' %}selected{% endif %}>Repairing - Work in progress</option>
                                <option value="Waiting Parts" {% if device.status == 'Waiting Parts' %}selected{% endif %}>Waiting Parts - Parts on order</option>
                                <option value="Ready" {% if device.status == 'Ready' %}selected{% endif %}>Ready - Ready for pickup</option>
                                <option value="Completed" {% if device.status == 'Completed' %}selected{% endif %}>Completed - Customer collected</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="diagnostic_fee" class="form-label">Diagnostic Fee (₱)</label>
                            <input type="number" class="form-control" id="diagnostic_fee" name="diagnostic_fee" step="0.01" value="{{ device.diagnostic_fee or 0 }}" placeholder="0.00">
                        </div>
                        <div class="col-md-6">
                            <label for="repair_cost" class="form-label">Repair/Labor Cost (₱)</label>
                            <input type="number" class="form-control" id="repair_cost" name="repair_cost" step="0.01" value="{{ device.repair_cost or 0 }}" placeholder="0.00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="technician_notes" class="form-label">Technician Notes</label>
                        <textarea class="form-control" id="technician_notes" name="technician_notes" rows="2" placeholder="Record findings, work done, or any issues">{{ device.technician_notes or '' }}</textarea>
                        <small class="text-muted">Internal notes for reference</small>
                    </div>

                    <div class="mb-3">
                        <label for="solution_applied" class="form-label">Solution Applied</label>
                        <textarea class="form-control" id="solution_applied" name="solution_applied" rows="2" placeholder="Describe the solution implemented">{{ device.solution_applied or '' }}</textarea>
                        <small class="text-muted">Summary of what was fixed</small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </form>
            </div>
        </div>

        <!-- Parts Used -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Parts Used</h5>
            </div>
            <div class="card-body">
                {% if device.parts_used_rows %}
                <div class="table-responsive mb-4">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Line Total</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for part in device.parts_used_rows %}
                            <tr data-part-id="{{ part.id }}" data-qty="{{ part.qty }}">
                                <td>{{ part.product.name }}</td>
                                <td class="text-end qty-display">{{ part.qty }}</td>
                                <td class="text-end price-cell" style="cursor: pointer; background-color: #f8f9fa; padding: 8px;" title="Click to edit price">
                                    <span class="price-display">{{ part.unit_price|currency }}</span>
                                    <input type="number" class="form-control form-control-sm price-input" style="display:none; width:100px;" step="0.01" min="0" value="{{ part.unit_price }}">
                                </td>
                                <td class="text-end fw-bold line-total-cell">{{ part.line_total|currency }}</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-qty-btn" data-part-id="{{ part.id }}" data-bs-toggle="modal" data-bs-target="#editQtyModal">
                                        <i class="bi bi-pencil"></i> Edit Qty
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No parts added yet</p>
                {% endif %}

                <form method="POST" action="{{ url_for('repairs.add_part_used', device_id=device.id) }}" class="mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="product_id" class="form-label">Add Part</label>
                            <select class="form-select" id="product_id" name="product_id" required>
                                <option value="">-- Select Product --</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} ({{ product.sell_price|currency }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="qty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="qty" name="qty" min="1" value="1" required>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-plus-circle"></i> Add Part
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar: Financial Info & Actions -->
    <div class="col-lg-4">
        <!-- Financial Summary -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Financial Summary</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-6">Diagnostic Fee:</div>
                    <div class="col-6 text-end fw-bold">{{ device.diagnostic_fee|currency }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">Repair Cost:</div>
                    <div class="col-6 text-end fw-bold">{{ device.repair_cost|currency }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">Parts Cost:</div>
                    <div class="col-6 text-end fw-bold">{{ device.parts_cost|currency }}</div>
                </div>
                <hr>
                <div class="row mb-2">
                    <div class="col-6"><strong>Total Cost:</strong></div>
                    <div class="col-6 text-end"><strong>{{ device.total_cost|currency }}</strong></div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Deposit Paid:</strong></div>
                    <div class="col-6 text-end"><strong>{{ device.deposit_paid|currency }}</strong></div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6"><strong>Balance Due:</strong></div>
                    <div class="col-6 text-end">
                        <strong class="{% if device.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ device.balance_due|currency }}
                        </strong>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <span class="badge bg-{% if device.payment_status == 'Paid' %}success{% elif device.payment_status == 'Partial' %}warning{% else %}danger{% endif %}">
                        {{ device.payment_status }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Record Payment -->
        {% if device.balance_due > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-credit-card"></i> Record Payment</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('repairs.add_payment', device_id=device.id) }}">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Check">Check</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> Record Payment
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Dates Info -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-calendar"></i> Dates</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Received Date:</strong><br>
                    {{ device.received_date|datetimeformat }}
                </div>
                {% if device.estimated_completion %}
                <div class="mb-2">
                    <strong>Est. Completion:</strong><br>
                    {{ device.estimated_completion|datetimeformat }}
                </div>
                {% endif %}
                {% if device.actual_completion %}
                <div class="mb-2">
                    <strong>Completed Date:</strong><br>
                    {{ device.actual_completion|datetimeformat }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    // Make unit price editable in parts table
    document.querySelectorAll('.price-cell').forEach(cell => {
        cell.addEventListener('click', function(){
            const display = this.querySelector('.price-display');
            const input = this.querySelector('.price-input');
            if (display.style.display !== 'none') {
                display.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select();
            }
        });

        const input = cell.querySelector('.price-input');
        input.addEventListener('blur', function(){
            updateLineTotal(this);
        });
        input.addEventListener('keypress', function(e){
            if (e.key === 'Enter') updateLineTotal(this);
        });
    });

    function updateLineTotal(priceInput){
        const row = priceInput.closest('tr');
        const qty = parseInt(row.dataset.qty);
        const newPrice = parseFloat(priceInput.value);
        if (isNaN(newPrice) || newPrice < 0) {
            alert('Please enter a valid price');
            return;
        }
        const lineTotal = (newPrice * qty).toFixed(2);
        const lineTotalCell = row.querySelector('.line-total-cell');
        lineTotalCell.textContent = '₱' + parseFloat(lineTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const display = priceInput.previousElementSibling;
        display.textContent = '₱' + parseFloat(newPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        display.style.display = 'block';
        priceInput.style.display = 'none';
    }
});
</script>

<!-- Modal for Editing Part Quantity -->
<div class="modal fade" id="editQtyModal" tabindex="-1" aria-labelledby="editQtyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editQtyModalLabel">Edit Part Quantity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editQtyForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="newQty" class="form-label">New Quantity</label>
            <input type="number" class="form-control" id="newQty" name="qty" min="1" required>
          </div>
          <small class="text-muted">Changing the quantity will adjust stock levels accordingly.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Quantity</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const editQtyModal = document.getElementById('editQtyModal');
    const editQtyForm = document.getElementById('editQtyForm');
    const newQtyInput = document.getElementById('newQty');
    let currentPartId = null;

    // Handle edit quantity button clicks
    document.querySelectorAll('.edit-qty-btn').forEach(btn => {
        btn.addEventListener('click', function(){
            currentPartId = this.dataset.partId;
            const row = document.querySelector(`tr[data-part-id="${currentPartId}"]`);
            const currentQty = row.dataset.qty;
            newQtyInput.value = currentQty;
        });
    });

    // Handle form submission
    editQtyForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const newQty = parseInt(newQtyInput.value);
        
        if (!currentPartId || newQty <= 0) {
            alert('Invalid quantity');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('qty', newQty);
            
            const baseUrl = '{{ url_for("repairs.update_part_qty", device_id=device.id, part_id=0) }}';
            const updateUrl = baseUrl.replace('/0/', `/${currentPartId}/`);
            
            const res = await fetch(updateUrl, {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const data = await res.json();
                if (data.success) {
                    // Update the row
                    const row = document.querySelector(`tr[data-part-id="${currentPartId}"]`);
                    row.dataset.qty = newQty;
                    row.querySelector('.qty-display').textContent = newQty;
                    row.querySelector('.line-total-cell').textContent = data.line_total;
                    
                    bootstrap.Modal.getInstance(editQtyModal).hide();
                    alert('Quantity updated successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            } else {
                alert('Error updating quantity');
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });
});
</script>
{% endblock %}
