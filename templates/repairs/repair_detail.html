{% extends "layouts/base.html" %}

{% block title %}{{ device.ticket_number }} - Repair Detail - JC Icons{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-2">
                <i class="bi bi-tools"></i> Repair Ticket #{{ device.ticket_number }}
            </h1>
            <p class="text-muted mb-0">
                <strong>Customer:</strong> {{ device.owner.display_name }}
                {% if device.owner and device.owner.business_name %}
                  <span class="badge bg-light text-dark ms-2"><i class="bi bi-briefcase"></i> {{ device.owner.business_name }}</span>
                {% endif %}<br>
                <strong>Phone:</strong> {{ device.owner.phone }}<br>
                <strong>Days in Shop:</strong> <span class="badge bg-warning">{{ days_in_shop }} days</span>
            </p>
        </div>
        <div class="text-end">
            <span class="badge bg-secondary me-2">{{ device.status }}</span>
            {% if device.priority == 'Emergency' %}
                <span class="badge bg-danger">{{ device.priority }} Priority</span>
            {% elif device.priority == 'High' %}
                <span class="badge bg-warning text-dark">{{ device.priority }} Priority</span>
            {% elif device.priority == 'Normal' %}
                <span class="badge bg-info">{{ device.priority }} Priority</span>
            {% else %}
                <span class="badge bg-success">{{ device.priority }} Priority</span>
            {% endif %}
        </div>
    </div>

    <div class="btn-group" role="group">
        <a href="{{ url_for('repairs.repairs') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Repairs
        </a>
        <a href="{{ url_for('repairs.print_ticket', device_id=device.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-printer"></i> Print Ticket
        </a>
        <a href="{{ url_for('repairs.print_receipt', device_id=device.id) }}" class="btn btn-outline-success">
            <i class="bi bi-receipt"></i> Print Receipt
        </a>
        {% if device.status == 'Completed' and not device.is_archived and (current_user.role == 'ADMIN' or current_user.role == 'TECH') %}
        <form method="POST" action="{{ url_for('repairs.archive_repair', device_id=device.id) }}" style="display:inline; margin-left:6px;">
            <button type="submit" class="btn btn-outline-secondary" onclick="return confirm('Archive this completed repair? This will hide it from the active list.');">
                <i class="bi bi-archive"></i> Archive
            </button>
        </form>
        {% endif %}

        {% if current_user.role == 'ADMIN' %}
        <form method="POST" action="{{ url_for('repairs.delete_repair', device_id=device.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete this repair ticket? This will attempt to restore used parts to stock.');">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
        {% if device.payment_status == 'Paid' or device.is_archived %}
        <form method="POST" action="{{ url_for('repairs.revert_repair', device_id=device.id) }}" style="display:inline; margin-left:6px;">
            <button type="submit" class="btn btn-outline-warning" onclick="return confirm('Revert this repair to editable state? This will allow editing parts and prices.');">
                <i class="bi bi-arrow-counterclockwise"></i> Revert to editable
            </button>
        </form>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Device Information -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-laptop"></i> Device Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Device Type:</strong> {{ device.device_type|title }}<br>
                        <strong>Brand:</strong> {{ device.brand or 'N/A' }}<br>
                        <strong>Model:</strong> {{ device.model or 'N/A' }}<br>
                        <strong>Serial Number:</strong> {{ device.serial_number or 'N/A' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Issue:</strong> {{ device.issue_description }}<br>
                        <strong>Symptoms:</strong> {{ device.symptoms or 'None' }}<br>
                        <strong>Device Age:</strong> {{ device.device_age or 'Not specified' }}<br>
                        <strong>Warranty:</strong> {% if device.is_warranty_repair == 'yes' %}Yes{% elif device.is_warranty_repair == 'unsure' %}Unsure{% else %}No{% endif %}
                    </div>
                </div>

                {% if device.payment_status != 'Paid' and not device.is_archived %}
                <!-- Toggle button to reveal inline edit form -->
                <button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#editDeviceCollapse" aria-expanded="false" aria-controls="editDeviceCollapse">
                    <i class="bi bi-pencil-square"></i> Edit device details
                </button>

                <div class="collapse" id="editDeviceCollapse">
                    <form method="POST" action="{{ url_for('repairs.update_device_details', device_id=device.id) }}">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label">Device Type</label>
                                <input name="device_type" class="form-control" value="{{ device.device_type }}" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Brand</label>
                                <input name="brand" class="form-control" value="{{ device.brand or '' }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Model</label>
                                <input name="model" class="form-control" value="{{ device.model or '' }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Serial Number</label>
                                <input name="serial_number" class="form-control" value="{{ device.serial_number or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Device Age</label>
                                <input name="device_age" class="form-control" value="{{ device.device_age or '' }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Issue Description</label>
                                <textarea name="issue_description" class="form-control" rows="2">{{ device.issue_description or '' }}</textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Accessories</label>
                                <input name="accessories" class="form-control" value="{{ device.accessories or '' }}">
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">Save device details</button>
                            <button type="button" class="btn btn-secondary ms-2" data-bs-toggle="collapse" data-bs-target="#editDeviceCollapse">Cancel</button>
                        </div>
                    </form>
                </div>
                {% else %}
                <button class="btn btn-outline-secondary mb-3" disabled title="Locked — revert to edit"><i class="bi bi-pencil-square"></i> Edit device details</button>
                <div class="mt-3 text-muted small">Device details are locked while repair is Paid or archived. Use Revert to enable edits.</div>
                {% endif %}

                {% if device.accessories %}
                <div class="mb-2">
                    <strong>Accessories:</strong><br>
                    <span class="text-muted">{{ device.accessories }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Status & Notes Update -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Update Repair Status</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('repairs.update_status', device_id=device.id) }}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">Current Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="Received" {% if device.status == 'Received' %}selected{% endif %}>Received - Initial intake</option>
                                <option value="Diagnosing" {% if device.status == 'Diagnosing' %}selected{% endif %}>Diagnosing - Testing in progress</option>
                                <option value="Repairing" {% if device.status == 'Repairing' %}selected{% endif %}>Repairing - Work in progress</option>
                                <option value="Waiting Parts" {% if device.status == 'Waiting Parts' %}selected{% endif %}>Waiting Parts - Parts on order</option>
                                <option value="Ready" {% if device.status == 'Ready' %}selected{% endif %}>Ready - Ready for pickup</option>
                                <option value="Completed" {% if device.status == 'Completed' %}selected{% endif %}>Completed - Customer collected</option>
                                <option value="Beyond repair" {% if device.status == 'Beyond repair' %}selected{% endif %}>Beyond repair</option>
                                <option value="Pulled out" {% if device.status == 'Pulled out' %}selected{% endif %}>Pulled out - Customer took device (no charge)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="diagnostic_fee" class="form-label">Diagnostic Fee (₱)</label>
                            <input type="number" class="form-control" id="diagnostic_fee" name="diagnostic_fee" step="0.01" value="{{ device.diagnostic_fee or 0 }}" placeholder="0.00">
                        </div>
                        <div class="col-md-6">
                            <label for="repair_cost" class="form-label">Repair/Labor Cost (₱)</label>
                            <input type="number" class="form-control" id="repair_cost" name="repair_cost" step="0.01" value="{{ device.repair_cost or 0 }}" placeholder="0.00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="technician_notes" class="form-label">Technician Notes</label>
                        <textarea class="form-control" id="technician_notes" name="technician_notes" rows="2" placeholder="Record findings, work done, or any issues">{{ device.technician_notes or '' }}</textarea>
                        <small class="text-muted">Internal notes for reference</small>
                    </div>

                    <div class="mb-3">
                        <label for="solution_applied" class="form-label">Solution Applied</label>
                        <textarea class="form-control" id="solution_applied" name="solution_applied" rows="2" placeholder="Describe the solution implemented">{{ device.solution_applied or '' }}</textarea>
                        <small class="text-muted">Summary of what was fixed</small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </form>
            </div>
        </div>

        <!-- Parts Used -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Parts Used</h5>
                {% if device.parts_used_rows %}
                <span class="badge bg-primary">{{ device.parts_used_rows|length }} part(s)</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if device.parts_used_rows %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><i class="bi bi-box"></i> Product</th>
                                <th class="text-center"><i class="bi bi-hash"></i> Qty</th>
                                <th class="text-end"><i class="bi bi-tag"></i> Unit Price</th>
                                <th class="text-end"><i class="bi bi-calculator"></i> Line Total</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for part in device.parts_used_rows %}
                            <tr data-part-id="{{ part.id }}" data-qty="{{ part.qty }}" class="align-middle">
                                <td><small class="text-muted">{{ part.product.name }}</small></td>
                                <td class="text-center qty-display fw-bold">{{ part.qty }}</td>
                                <td class="text-end price-cell {% if device.payment_status == 'Paid' or device.is_archived %}locked{% endif %}" {% if device.payment_status != 'Paid' and not device.is_archived %}data-editable="true"{% endif %} style="padding: 8px; border-radius: 4px;" title="{% if device.payment_status != 'Paid' and not device.is_archived %}Click to edit price{% else %}Locked from editing{% endif %}">
                                    <span class="price-display fw-bold">{{ part.unit_price|currency }}</span>
                                    {% if device.payment_status != 'Paid' and not device.is_archived %}
                                    <input type="number" class="form-control form-control-sm price-input" style="display:none; width:100px;" step="0.01" min="0" value="{{ part.unit_price }}">
                                    {% endif %}
                                </td>
                                <td class="text-end"><strong class="line-total-cell fs-6" style="color: #0d6efd;">{{ part.line_total|currency }}</strong></td>
                                <td class="text-center">
                                    {% if device.payment_status != 'Paid' and not device.is_archived %}
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary edit-qty-btn" data-part-id="{{ part.id }}" data-bs-toggle="modal" data-bs-target="#editQtyModal" title="Edit quantity">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger delete-part-btn" data-part-id="{{ part.id }}" title="Remove part">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <span class="badge bg-secondary">Locked</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-end text-muted small">
                    {% if device.payment_status != 'Paid' and not device.is_archived %}
                    <i class="bi bi-info-circle"></i> Click price to edit • Use buttons for qty/delete
                    {% else %}
                    <i class="bi bi-lock"></i> Parts locked (repair is processing/archived)
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem; color: #ccc;"></i>
                    <p class="text-muted mt-2">No parts added yet</p>
                </div>
                {% endif %}

                <form id="addPartForm" method="POST" action="{{ url_for('repairs.add_part_used', device_id=device.id) }}" class="mt-4">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="product_search" class="form-label">Search & Add Part</label>
                            <input type="text" class="form-control mb-2" id="product_search" placeholder="Search by part name...">
                            <select class="form-select" id="product_id" name="product_id" required>
                                <option value="">-- Select Product --</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" data-name="{{ product.name|lower }}">{{ product.name }} ({{ product.sell_price|currency }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="qty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="qty" name="qty" min="1" value="1" required>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-plus-circle"></i> Add Part
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar: Financial Info & Actions -->
    <div class="col-lg-4">
        <!-- Financial Summary -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Financial Summary</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-6">Diagnostic Fee:</div>
                    <div class="col-6 text-end fw-bold">{{ device.diagnostic_fee|currency }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">Repair Cost:</div>
                    <div class="col-6 text-end fw-bold">{{ device.repair_cost|currency }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">Parts Cost:</div>
                    <div class="col-6 text-end fw-bold">{{ device.parts_cost|currency }}</div>
                </div>
                <hr>
                <div class="row mb-2">
                    <div class="col-6"><strong>Total Cost:</strong></div>
                    <div class="col-6 text-end"><strong>{{ device.total_cost|currency }}</strong></div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Deposit Paid:</strong></div>
                    <div class="col-6 text-end"><strong id="depositDisplay">{% if device.deposit_paid and device.deposit_paid > 0 %}{{ device.deposit_paid|currency }}{% else %}<em>None</em>{% endif %}</strong></div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6"><strong>Balance Due:</strong></div>
                    <div class="col-6 text-end">
                        <strong class="{% if device.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ device.balance_due|currency }}
                        </strong>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <span class="badge bg-{% if device.payment_status == 'Paid' %}success{% elif device.payment_status == 'Partial' %}warning{% else %}danger{% endif %}">
                        {{ device.payment_status }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Add/Edit Deposit -->
        {% if device.payment_status != 'Paid' and not device.is_archived %}
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-piggy-bank"></i> Add/Edit Deposit</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('repairs.update_deposit', device_id=device.id) }}" id="depositForm">
                    <div class="mb-3">
                        <label for="deposit_amount" class="form-label">Deposit Amount</label>
                        <input type="number" class="form-control" id="deposit_amount" name="deposit_amount" step="0.01" min="0" value="{{ device.deposit_paid or '0.00' }}" required>
                        <small class="form-text text-muted">Current total cost: ₱{{ "%.2f"|format(device.total_cost) }}</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check-circle"></i> Save Deposit
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Record Payment -->
        {% if device.balance_due > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-credit-card"></i> Record Payment</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('repairs.add_payment', device_id=device.id) }}">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Check">Check</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="apply_as_deposit" name="apply_as_deposit" value="yes">
                        <input type="hidden" name="apply_as_deposit" value="no">
                        <label class="form-check-label" for="apply_as_deposit">Apply payment as deposit (keep deposit record)</label>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> Record Payment
                    </button>
                </form>

                <!-- Claim on credit (release without payment) -->
                {% if not device.claimed_on_credit and device.balance_due > 0 %}
                <form method="POST" action="{{ url_for('repairs.claim_on_credit', device_id=device.id) }}" class="mt-2">
                    <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Release device on credit (customer takes device without paying now)?');">
                        <i class="bi bi-person-check"></i> Claim on credit (release unpaid)
                    </button>
                </form>
                {% elif device.claimed_on_credit %}
                <div class="mt-2 text-center small text-muted">This device was released on credit (unpaid).</div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Dates Info -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-calendar"></i> Dates</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Received Date:</strong><br>
                    {{ device.received_date|datetimeformat }}
                </div>
                {% if device.estimated_completion %}
                <div class="mb-2">
                    <strong>Est. Completion:</strong><br>
                    {{ device.estimated_completion|datetimeformat }}
                </div>
                {% endif %}
                {% if device.actual_completion %}
                <div class="mb-2">
                    <strong>Completed Date:</strong><br>
                    {{ device.actual_completion|datetimeformat }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.price-cell[data-editable="true"] {
    cursor: pointer;
    background-color: #e7f1ff;
}

.price-cell.locked {
    background-color: #f8f9fa;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    // Product search functionality for Add Part form
    const searchInput = document.getElementById('product_search');
    const productSelect = document.getElementById('product_id');

    if (searchInput && productSelect) {
        searchInput.addEventListener('input', function(){
            const searchTerm = this.value.toLowerCase().trim();
            const options = productSelect.querySelectorAll('option');
            let hasMatches = false;

            if (!searchTerm) {
                // Show all options when search is empty
                options.forEach(option => {
                    option.style.display = '';
                });
                return;
            }

            // Enhanced matching: exact words, partial words, and fuzzy matching
            function getMatchScore(productName, searchTerm) {
                const name = productName.toLowerCase();
                const terms = searchTerm.split(/\s+/);
                let score = 0;

                terms.forEach(term => {
                    // Exact word match (highest priority)
                    if (name.split(/\s+/).some(word => word === term)) {
                        score += 100;
                    }
                    // Word starts with term
                    else if (name.split(/\s+/).some(word => word.startsWith(term))) {
                        score += 50;
                    }
                    // Substring match
                    else if (name.includes(term)) {
                        score += 25;
                    }
                    // Partial character match (at least 70% similar)
                    else {
                        const matches = term.split('').filter(char => name.includes(char)).length;
                        if (matches >= term.length * 0.7) {
                            score += 10;
                        }
                    }
                });

                return score;
            }

            // Calculate scores and sort options
            const optionsWithScores = [];
            options.forEach(option => {
                if (option.value === '') return; // Skip default option

                const productName = option.dataset.name || option.textContent.toLowerCase();
                const score = getMatchScore(productName, searchTerm);
                
                if (score > 0) {
                    optionsWithScores.push({ option, score });
                    hasMatches = true;
                }
            });

            // Sort by score (highest first)
            optionsWithScores.sort((a, b) => b.score - a.score);

            // Update display
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = ''; // Always show default
                    return;
                }
                option.style.display = 'none';
            });

            // Show matching options in order
            optionsWithScores.forEach(({ option }) => {
                option.style.display = '';
            });

            // Open dropdown to show results
            if (hasMatches) {
                productSelect.size = Math.min(optionsWithScores.length + 1, 8); // Show up to 8 options
            }
        });

        // Reset dropdown size when clicking away
        searchInput.addEventListener('blur', function(){
            setTimeout(() => {
                productSelect.size = 0; // Reset to normal dropdown
            }, 200);
        });

        // Clear search when select changes
        productSelect.addEventListener('change', function(){
            if (this.value) {
                searchInput.value = '';
                this.size = 0; // Reset dropdown size
            }
        });

        // Allow typing to search in the select too
        productSelect.addEventListener('keydown', function(e){
            if (e.key.length === 1) {
                searchInput.value += e.key.toLowerCase();
                searchInput.dispatchEvent(new Event('input'));
            }
        });
    }

    // Make unit price editable in parts table
// Handle adding parts via AJAX to update UI without full reload
document.addEventListener('DOMContentLoaded', function(){
    const addPartForm = document.getElementById('addPartForm');
    if (!addPartForm) return;

    addPartForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const form = e.target;
        const url = form.action;
        const formData = new FormData(form);

        try {
            const res = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            });

            if (!res.ok) throw new Error('Server error');
            const data = await res.json();
            if (!data.success) throw new Error(data.message || 'Error adding part');

            // Scope to the parts card body (closest to the form)
            const partsCardBody = form.closest('.card-body');
            // Remove 'No parts added yet' text if present inside parts card
            const noParts = partsCardBody.querySelector('p.text-muted');
            if (noParts) noParts.remove();

            // Append new row to parts table inside parts card
            const tbody = partsCardBody.querySelector('.table-responsive table tbody');
            if (tbody && data.part) {
                const tr = document.createElement('tr');
                tr.dataset.partId = data.part.id;
                tr.dataset.qty = data.part.qty;

                tr.innerHTML = `
                    <td>${data.part.product_name}</td>
                    <td class="text-end qty-display">${data.part.qty}</td>
                    <td class="text-end price-cell" style="cursor: pointer; background-color: #f8f9fa; padding: 8px;" title="Click to edit price">
                        <span class="price-display">₱${parseFloat(data.part.unit_price).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                        <input type="number" class="form-control form-control-sm price-input" style="display:none; width:100px;" step="0.01" min="0" value="${parseFloat(data.part.unit_price)}">
                    </td>
                    <td class="text-end fw-bold line-total-cell">₱${parseFloat(data.part.line_total).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary edit-qty-btn" data-part-id="${data.part.id}" data-bs-toggle="modal" data-bs-target="#editQtyModal">
                            <i class="bi bi-pencil"></i> Edit Qty
                        </button>
                    </td>
                `;

                tbody.prepend(tr);

                // Attach price edit handlers for the new row (scoped)
                const priceCell = tr.querySelector('.price-cell');
                if (priceCell) {
                    priceCell.addEventListener('click', function(){
                        const display = this.querySelector('.price-display');
                        const input = this.querySelector('.price-input');
                        if (display) display.style.display = 'none';
                        if (input) { input.style.display = 'block'; input.focus(); input.select(); }
                    });
                    const priceInput = tr.querySelector('.price-input');
                    if (priceInput) {
                        priceInput.addEventListener('blur', function(){ updateLineTotal(this); });
                        priceInput.addEventListener('keypress', function(e){ if (e.key === 'Enter') updateLineTotal(this); });
                    }
                }
            }

            // Update financial summary
            updateFinancialSummary(data);

            // Reset form
            form.reset();
        } catch (err) {
            alert('Error adding part: ' + err.message);
        }
    });
});
    document.querySelectorAll('.price-cell').forEach(cell => {
        // skip locked rows or cells without an editable input
        if (cell.classList.contains('locked')) return;
        const display = cell.querySelector('.price-display');
        const input = cell.querySelector('.price-input');
        if (!input) return;

        cell.addEventListener('click', function(){
            if (display && display.style.display !== 'none') {
                display.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select && input.select();
            }
        });

        input.addEventListener('blur', function(){
            updateLineTotal(this);
        });
        input.addEventListener('keypress', function(e){
            if (e.key === 'Enter') updateLineTotal(this);
        });
    });

    function updateLineTotal(priceInput){
        const row = priceInput.closest('tr');
        const qty = parseInt(row.dataset.qty);
        const newPrice = parseFloat(priceInput.value);
        if (isNaN(newPrice) || newPrice < 0) {
            alert('Please enter a valid price');
            return;
        }

        const partId = row.dataset.partId;
        // Update backend with new price
        (async () => {
            try {
                const baseUrl = '{{ url_for("repairs.update_part_price", device_id=device.id, part_id=0) }}';
                const updateUrl = baseUrl.replace('/0/', `/${partId}/`);
                const formData = new FormData();
                formData.append('price', newPrice);

                const res = await fetch(updateUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                });

                if (!res.ok) throw new Error('Server error');
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'Error');

                const lineTotalCell = row.querySelector('.line-total-cell');
                lineTotalCell.textContent = '₱' + parseFloat(data.line_total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const display = priceInput.previousElementSibling;
                display.textContent = '₱' + parseFloat(newPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                display.style.display = 'block';
                priceInput.style.display = 'none';

                // Update financial summary
                updateFinancialSummary(data);
            } catch (err) {
                alert('Error updating price: ' + err.message);
            }
        })();
    }
});
</script>

<script>
// Function to update financial summary sidebar
function updateFinancialSummary(data) {
    const formatCurrency = (value) => {
        return '₱' + parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    };

    // Find the financial summary card by header text
    const cards = document.querySelectorAll('.card');
    let financialCard = null;
    for (let card of cards) {
        const header = card.querySelector('.card-header');
        if (header && header.textContent && header.textContent.trim().includes('Financial Summary')) {
            financialCard = card;
            break;
        }
    }
    if (!financialCard) return;

    const cardBody = financialCard.querySelector('.card-body');

    // Helper to find the value cell by left label text
    function findValueCell(labelStartsWith) {
        const rows = cardBody.querySelectorAll('.row');
        for (let r of rows) {
            const left = r.querySelector('div.col-6');
            if (!left) continue;
            if (left.textContent.trim().startsWith(labelStartsWith)) {
                return r.querySelector('div.col-6:last-child');
            }
        }
        return null;
    }

    const partsCell = findValueCell('Parts Cost');
    if (partsCell) partsCell.textContent = formatCurrency(data.parts_cost);

    const totalCell = findValueCell('Total Cost');
    if (totalCell) {
        const strong = totalCell.querySelector('strong');
        if (strong) strong.textContent = formatCurrency(data.total_cost);
        else totalCell.textContent = formatCurrency(data.total_cost);
    }

    const depositCell = findValueCell('Deposit Paid');
    if (depositCell) {
        const strong = depositCell.querySelector('strong');
        if (strong) strong.textContent = formatCurrency(data.deposit_paid);
        else depositCell.textContent = formatCurrency(data.deposit_paid);
    }

    const balanceCell = findValueCell('Balance Due');
    if (balanceCell) {
        const strong = balanceCell.querySelector('strong');
        if (strong) {
            strong.textContent = formatCurrency(data.balance_due);
            strong.className = parseFloat(data.balance_due) > 0 ? 'text-danger' : 'text-success';
        } else {
            balanceCell.textContent = formatCurrency(data.balance_due);
            balanceCell.className = parseFloat(data.balance_due) > 0 ? 'text-danger' : 'text-success';
        }
    }

    // Update Payment Status Badge
    const badgeContainer = financialCard.querySelector('.mt-2.text-center');
    if (badgeContainer) {
        const badgeClass = data.payment_status === 'Paid' ? 'bg-success' : 
                          data.payment_status === 'Partial' ? 'bg-warning' : 'bg-danger';
        badgeContainer.innerHTML = `<span class="badge ${badgeClass}">${data.payment_status}</span>`;
    }

    // If balance due is now 0 or less, hide the payment form
    const paymentCard = Array.from(document.querySelectorAll('.card')).find(c => c.querySelector('.card-header') && c.querySelector('.card-header').textContent.includes('Record Payment'));
    if (paymentCard) {
        if (parseFloat(data.balance_due) <= 0) paymentCard.style.display = 'none';
        else paymentCard.style.display = '';
    }
}
</script>

<!-- Modal for Editing Part Quantity -->
<div class="modal fade" id="editQtyModal" tabindex="-1" aria-labelledby="editQtyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editQtyModalLabel">Edit Part Quantity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editQtyForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="newQty" class="form-label">New Quantity</label>
            <input type="number" class="form-control" id="newQty" name="qty" min="1" required>
          </div>
          <small class="text-muted">Changing the quantity will adjust stock levels accordingly.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Quantity</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const editQtyModal = document.getElementById('editQtyModal');
    const editQtyForm = document.getElementById('editQtyForm');
    const newQtyInput = document.getElementById('newQty');
    let currentPartId = null;

    // Handle edit quantity button clicks
    document.querySelectorAll('.edit-qty-btn').forEach(btn => {
        btn.addEventListener('click', function(){
            currentPartId = this.dataset.partId;
            const row = document.querySelector(`tr[data-part-id="${currentPartId}"]`);
            const currentQty = row.dataset.qty;
            newQtyInput.value = currentQty;
        });
    });

    // Handle form submission
    editQtyForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const newQty = parseInt(newQtyInput.value);
        
        if (!currentPartId || newQty <= 0) {
            alert('Invalid quantity');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('qty', newQty);
            
            const baseUrl = '{{ url_for("repairs.update_part_qty", device_id=device.id, part_id=0) }}';
            const updateUrl = baseUrl.replace('/0/', `/${currentPartId}/`);
            
            const res = await fetch(updateUrl, {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const data = await res.json();
                if (data.success) {
                    // Update the row
                    const row = document.querySelector(`tr[data-part-id="${currentPartId}"]`);
                    row.dataset.qty = newQty;
                    row.querySelector('.qty-display').textContent = newQty;
                    row.querySelector('.line-total-cell').textContent = '₱' + parseFloat(data.line_total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    
                    // Update financial summary sidebar
                    updateFinancialSummary(data);
                    
                    bootstrap.Modal.getInstance(editQtyModal).hide();

                    // If there's still balance due, show payment card and prompt for payment
                    if (parseFloat(data.balance_due) > 0) {
                        const paymentCard = Array.from(document.querySelectorAll('.card')).find(c => c.querySelector('.card-header') && c.querySelector('.card-header').textContent.includes('Record Payment'));
                        if (paymentCard) {
                            paymentCard.style.display = '';
                            // Scroll into view and focus amount input
                            paymentCard.scrollIntoView({behavior: 'smooth', block: 'center'});
                            const amt = paymentCard.querySelector('input[name="amount"]');
                            const pm = paymentCard.querySelector('select[name="payment_method"]');
                            if (amt) { amt.focus(); amt.value = parseFloat(data.balance_due).toFixed(2); }
                            if (pm) { pm.focus(); }
                        }
                        alert('Quantity updated. Remaining balance detected — please record payment.');
                    } else {
                        alert('Quantity updated successfully!');
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            } else {
                const json = await res.json().catch(()=>null);
                alert('Error updating quantity: ' + (json && json.message ? json.message : res.statusText));
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });

    // Delete part handler (AJAX)
    document.querySelectorAll('.delete-part-btn').forEach(btn => {
        btn.addEventListener('click', async function(){
            const partId = this.dataset.partId;
            if (!confirm('Remove this part from the repair and restore stock?')) return;
            try {
                const baseUrl = '{{ url_for("repairs.delete_part", device_id=device.id, part_id=0) }}';
                const delUrl = baseUrl.replace('/0/', `/${partId}/`);
                const res = await fetch(delUrl, { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest'} });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.message || 'Server error');

                // Remove row and update financials
                const row = document.querySelector(`tr[data-part-id="${partId}"]`);
                if (row) row.remove();
                updateFinancialSummary(data);
            } catch (err) {
                alert('Error removing part: ' + err.message);
            }
        });
    });
});
</script>
{% endblock %}
