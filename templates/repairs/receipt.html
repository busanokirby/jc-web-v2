{% extends 'layouts/base.html' %}
{% block title %}Receipt {{ device.ticket_number }} - JC Icons{% endblock %}

{% block content %}
<div class="mb-2">

  <!-- SCREEN Header (not printed) -->
  <div class="bg-success text-white py-2 px-3 rounded-top d-flex justify-content-between align-items-center d-print-none">
    <div class="lh-1">
      <div class="fw-bold" style="font-size:1.05rem;">
        <i class="bi bi-receipt"></i> Repair Receipt
      </div>
      <div class="small">Receipt #{{ device.ticket_number }}</div>
    </div>
    <div>
      <button onclick="window.print()" class="btn btn-light btn-sm me-1">
        <i class="bi bi-printer"></i> Print
      </button>
      <a href="{{ url_for('repairs.repair_detail', device_id=device.id) }}" class="btn btn-light btn-sm">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </div>

  <!-- Card -->
  <div class="card border-success receipt-container">
    <div class="card-body p-2 p-md-3">

      <!-- PRINT Header (keep this) -->
      <div class="stub-header">
        <img
          src="{{ url_for('static', filename='images/jc-logo.png') }}"
          alt="JC Icons Logo"
          class="stub-logo"
        >

        <div class="stub-text">
          <div class="stub-title">JC ICONS COMPUTER SALES &amp; SERVICES</div>
          <div class="stub-sub">J.A CLARIN COR. HONTANOSAS, POBLACION 3, TAGBILARAN CITY</div>
          <div class="stub-contact">CONTACT: (038) 411-2134 • 09985771468 • 09208036494</div>
        </div>

        <div class="qr-code">
          <img src="{{ url_for('static', filename='images/qr-code.png') }}" alt="QR Code">
        </div>
      </div>

      <!-- Compact meta row -->
      <div class="d-flex justify-content-between align-items-start gap-2 mt-2 meta-row">
        <div class="lh-1">
          <div class="text-muted meta-label">Receipt #:<strong>{{ device.ticket_number }}</strong></div>
          <div class="fw-bold meta-value"></div>
        </div>

        <div class="text-end lh-1">
          <div class="meta-value">{{ now.strftime('%b %d, %Y %I:%M %p') }}</div>
        </div>

        <div class="text-end lh-1">
          <div class="text-muted meta-label">Status: <span class="badge badge-tight {% if device.payment_status == 'PAID' %}bg-success{% elif device.payment_status == 'PARTIAL' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
            {{ device.payment_status }}
          </span></div>
          
        </div>
      </div>

      <!-- Two-column compact info -->
      <div class="row g-2 mt-2">
        <div class="col-6">
          <div class="section-title">Customer: {{ device.owner.display_name if device.owner else '' }}</div>
          <div class="small text-muted">
            {% if device.owner.phone %}<div><i class="bi bi-telephone"></i> {{ device.owner.phone }}</div>{% endif %}
            {% if device.owner.address %}<div><i class="bi bi-geo-alt"></i> {{ device.owner.address }}</div>{% endif %}
          </div>
        </div>

        <div class="col-6">
          <div class="section-title" style="text-transform: uppercase;">Device: {{ device.device_type }}</div>
          <div class="small">
            <div><span class="text-muted">Unit:</span> <strong>{{ device.brand or 'N/A' }} {{ device.model or '' }}</strong></div>
            <div class="text-muted"><span class="text-muted">Issue:</span> {{ device.issue_description }}</div>
          </div>
        </div>
      </div>

      <!-- Parts (only if exists) -->
      {% if device.parts_used_rows %}
      <div class="section-title mt-2">Parts Used</div>
      <table class="table table-sm table-tight mb-1">
        <thead class="table-light">
          <tr>
            <th>Part</th>
            <th class="text-center" style="width:52px;">Qty</th>
            <th class="text-end" style="width:90px;">Unit</th>
            <th class="text-end" style="width:95px;">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for part in device.parts_used_rows %}
          <tr>
            <td class="text-truncate">{{ part.product.name if part.product else 'Unknown Part' }}</td>
            <td class="text-center">{{ part.qty }}</td>
            <td class="text-end">₱{{ "%.2f"|format(part.unit_price) }}</td>
            <td class="text-end">₱{{ "%.2f"|format(part.line_total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      <!-- Summary (tight, minimal) -->
      <div class="section-title mt-2">Summary</div>
      <table class="table table-sm table-tight mb-1">
        <tbody>
          <!--<tr><td>Diagnostic</td><td class="text-end">₱{{ "%.2f"|format(device.diagnostic_fee) }}</td></tr>-->
          <tr><td>Repair</td><td class="text-end">₱{{ "%.2f"|format(device.repair_cost) }}</td></tr>
          <tr><td>Parts</td><td class="text-end">₱{{ "%.2f"|format(device.parts_cost) }}</td></tr>
          <tr class="table-light">
            <td class="fw-bold">Total</td>
            <td class="text-end fw-bold">₱{{ "%.2f"|format(device.total_cost) }}</td>
          </tr>
          <tr>
            <td>Paid</td>
            <td class="text-end">
              {% if device.deposit_paid and device.deposit_paid > 0 %}
                ₱{{ "%.2f"|format(device.deposit_paid) }}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td class="fw-bold">Balance</td>
            <td class="text-end fw-bold">₱{{ "%.2f"|format(device.balance_due) }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Signatures: Released By (left), Client (right) -->
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:14px; align-items:flex-end;">
        <!-- Released By (current logged-in user; editable on-screen) -->
        <div style="flex:1; text-align:center;">
          
          <p class="mb-0" style="text-align:left; font-size:15px; font-weight:bold; margin-bottom:-3px; margin-left:5px;">Released By:</p>

          <div class="no-print" style="margin-top:6px;">
            <input id="released-by-input" type="text" value="{{ current_user.full_name }}" style="display:none; width:220px; text-align:center; padding:4px;" />
            <button id="released-by-edit-btn" class="btn btn-sm btn-outline-secondary no-print" type="button" style="padding:4px 8px; font-size:12px;">Edit</button>
            <button id="released-by-save-btn" class="btn btn-sm btn-success no-print" type="button" style="padding:4px 8px; font-size:12px; display:none;">Save</button>
            <button id="released-by-cancel-btn" class="btn btn-sm btn-secondary no-print" type="button" style="padding:4px 8px; font-size:12px; display:none;">Cancel</button>
          </div>
          <div class="bottom-sig-line" style="border-top:1px solid #000; width:80%; margin:6px auto 0; font-size:8px; padding-top:4px;"></div>
          <div id="released-by-display" style="text-align:center; font-size:15px; font-weight:bold; margin-bottom:-10px;"><strong>{{ current_user.full_name }}</strong></div>
        </div>

        <!-- Spacer to keep two-column layout centered -->
        <div style="flex:1;"></div>

        <!-- Client signature (moved to right) -->
        <div style="flex:1; text-align:center;">
          <div class="line" style="min-height:18px;">{{ device.owner.display_name if device.owner else '' }}</div>
          <div class="bottom-sig-line" style="border-top:1px solid #000; width:80%; margin:6px auto 0; font-size:8px; padding-top:4px;">CLIENT SIGNATURE OVER PRINTED NAME</div>
        </div>
      </div>

      <script>
      document.addEventListener('DOMContentLoaded', function(){
        const editBtn = document.getElementById('released-by-edit-btn');
        const saveBtn = document.getElementById('released-by-save-btn');
        const cancelBtn = document.getElementById('released-by-cancel-btn');
        const input = document.getElementById('released-by-input');
        const display = document.getElementById('released-by-display');
        if (!display || !editBtn) return;

        const original = display.textContent.trim();
        editBtn.addEventListener('click', function(){
          input.value = original;
          display.style.display = 'none';
          input.style.display = 'inline-block';
          editBtn.style.display = 'none';
          saveBtn.style.display = 'inline-block';
          cancelBtn.style.display = 'inline-block';
        });
        cancelBtn.addEventListener('click', function(){
          display.style.display = '';
          input.style.display = 'none';
          editBtn.style.display = '';
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
        });
        saveBtn.addEventListener('click', function(){
          const newName = (input.value || '').trim() || {{ current_user.full_name|tojson }};
          display.textContent = newName;
          display.style.display = '';
          input.style.display = 'none';
          editBtn.style.display = '';
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
        });
      });
      </script>

      <!-- Footer (super compact) -->
      <div class="text-center text-muted footer-compact mt-2">
        <p class="mb-0">Your Computer Needs... Our Job.</p>
            <p class="mb-0">Thank you for your continued trust in our services. We look forward to serving you again.</p>
            <p class="mb-0">If you have any questions regarding this transaction, please contact us.</p>
      </div>

    </div>
  </div>
</div>

<style>
  .receipt-container { max-width: 100%; }

  /* ---- Compact typography ---- */
  .section-title{
    font-weight:700;
    font-size:.78rem;
    margin:0;
  }
  .meta-row .meta-label{ font-size:.70rem; }
  .meta-row .meta-value{ font-size:.82rem; }
  .badge-tight{ padding:.25em .5em; font-size:.72rem; }

  /* ---- Stub header (printed header) ---- */
  .stub-header{
    background:#2ea863;
    color:#fff;
    padding:6px 8px;
    display:flex;
    align-items:center;
    gap:8px;
    position:relative;
    border-radius:6px;
  }
  .stub-logo{
    width:42px;
    height:42px;
    border-radius:50%;
    flex:0 0 auto;
  }
  .stub-text{ padding-right:58px; line-height:1.05; }
  .stub-title{ font-weight:900; font-size:12px; }
  .stub-sub{ font-size:8px; opacity:.95; }
  .stub-contact{ font-size:9px; font-weight:700; margin-top:2px; }

  .qr-code{
    width:46px;
    height:46px;
    background:#fff;
    position:absolute;
    right:6px;
    top:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    border-radius:4px;
  }
  .qr-code img{ width:100%; height:100%; display:block; }

  /* ---- Tight tables ---- */
  .table-tight > :not(caption) > * > *{
    padding:.18rem .35rem !important;
    line-height:1.1 !important;
  }

  .footer-compact{ font-size:.72rem; line-height:1.15; }
</style>

<style media="print">
  /* Hide UI controls / nav; KEEP stub-header */
  nav, .navbar, .d-print-none, .no-print, footer.jc-footer { display:none !important; }

  @page { size: A4; margin: 0.15in; }

  /* Remove card chrome */
  .card{ border:none !important; box-shadow:none !important; }
  .card-body{ padding:0 !important; }

  /* Ensure color prints */
  .stub-header{
    background-color:#2ea863 !important;
    color:#ffffff !important;
    -webkit-print-color-adjust:exact !important;
    print-color-adjust:exact !important;
  }
  .stub-header .qr-code{
    background:#ffffff !important;
    -webkit-print-color-adjust:exact !important;
    print-color-adjust:exact !important;
  }

  /* More compact print text */
  body{ font-size:9.5pt; line-height:1.15; }
</style>
{% endblock %}