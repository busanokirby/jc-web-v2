{% extends 'layouts/base.html' %}

{% block title %}Stock In - Inventory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-2">
            <i class="bi bi-box-arrow-in"></i> Stock In (Receive Inventory)
        </h1>
        <p class="text-muted mb-0">Record new incoming inventory and update stock levels</p>
    </div>
    <a class="btn btn-outline-secondary" href="{{ url_for('inventory.products') }}">
        <i class="bi bi-arrow-left"></i> Back to Products
    </a>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <form method="POST" id="stock-in-form">
            <!-- Product Selection -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam"></i> Select Product
                    </h5>
                </div>
                <div class="card-body">
                    {% if selected_product_id %}
                        {# Show selected product panel #}
                        {% set sel = products|selectattr('id','equalto', selected_product_id)|list %}
                        {% if sel and sel|length %}
                        <div id="selected-product-panel" class="alert alert-info d-flex align-items-center justify-content-between mb-0">
                            <div>
                                <h6 class="mb-1">
                                    <i class="bi bi-check-circle"></i> 
                                    <strong>{{ sel[0].name }}</strong>
                                </h6>
                                <small class="text-muted">
                                    Current stock: <strong>{{ sel[0].stock_on_hand }}</strong> units
                                </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="change-product-btn">
                                <i class="bi bi-pencil"></i> Change
                            </button>
                        </div>
                        <input type="hidden" name="product_id" value="{{ selected_product_id }}">
                        {% else %}
                        {# Fallback to select #}
                        <label class="form-label fw-bold">Product <span class="text-danger">*</span></label>
                        <select name="product_id" class="form-select form-select-lg" required>
                            <option value="">-- Select a Product --</option>
                            {% for p in products %}
                            <option value="{{ p.id }}" title="Current stock: {{ p.stock_on_hand }}">
                                {{ p.name }} (Stock: {{ p.stock_on_hand }})
                            </option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    {% else %}
                        {# Show product select #}
                        <label class="form-label fw-bold">Product <span class="text-danger">*</span></label>
                        <select name="product_id" class="form-select form-select-lg" required>
                            <option value="">-- Select a Product --</option>
                            {% for p in products %}
                            <option value="{{ p.id }}" title="Current stock: {{ p.stock_on_hand }}">
                                {{ p.name }} (Stock: {{ p.stock_on_hand }})
                            </option>
                            {% endfor %}
                        </select>
                    {% endif %}

                    <!-- Hidden Product Selector for Change -->
                    <div id="product-select-wrapper" class="mt-3" style="display: none;">
                        <label class="form-label mb-2">Choose a different product:</label>
                        <div class="input-group input-group-lg mb-3">
                            <input type="text" id="product-search" class="form-control" 
                                   placeholder="Type product name to search...">
                            <button class="btn btn-outline-secondary" type="button" id="product-search-btn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <ul class="list-group" id="product-search-results" style="max-height: 300px; overflow-y: auto;">
                            {% for p in products %}
                            <li class="list-group-item list-group-item-action product-search-item" 
                                data-id="{{ p.id }}"
                                data-name="{{ p.name }}"
                                data-stock="{{ p.stock_on_hand }}">
                                <strong>{{ p.name }}</strong>
                                <br><small class="text-muted">Current stock: {{ p.stock_on_hand }} units</small>
                            </li>
                            {% endfor %}
                        </ul>
                        <div id="product-search-none" class="mt-2 text-muted text-center py-3" style="display: none;">
                            <small>No products found</small>
                        </div>
                        <button type="button" class="btn btn-outline-secondary w-100 mt-3" id="cancel-change-btn">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>

                    <!-- Hidden: Product data for JavaScript -->
                    {% set product_list = [] %}
                    {% for p in products %}
                        {% set _ = product_list.append({"id": p.id, "name": p.name, "stock": p.stock_on_hand}) %}
                    {% endfor %}
                    <span id="product-data-store" data-products="{{ {"products": product_list} | tojson }}"></span>
                </div>
            </div>

            <!-- Quantity -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2"></i> Quantity to Receive
                    </h5>
                </div>
                <div class="card-body">
                    <label class="form-label fw-bold">Quantity <span class="text-danger">*</span></label>
                    <div class="input-group input-group-lg">
                        <input type="number" name="qty" id="qty-input" class="form-control" 
                               min="1" value="1" required 
                               placeholder="Enter quantity"
                               title="Number of units to add to stock">
                        <span class="input-group-text">units</span>
                    </div>
                    <small class="form-text text-muted d-block mt-2">
                        Enter the number of units being received in this shipment
                    </small>
                </div>
            </div>

            <!-- Notes (Optional) -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-sticky"></i> Notes (Optional)
                    </h5>
                </div>
                <div class="card-body">
                    <label class="form-label">Add notes</label>
                    <input type="text" name="notes" class="form-control" 
                           placeholder="e.g., PO#12345, Shipment from Supplier A, Damaged items noted">
                    <small class="form-text text-muted d-block mt-2">
                        Reference shipment number, supplier, or any relevant details
                    </small>
                </div>
            </div>

            <!-- Submit -->
            <div class="d-grid gap-2">
                <button id="add-stock-btn" class="btn btn-primary btn-lg" type="submit" disabled>
                    <i class="bi bi-check-circle"></i> Confirm Stock In
                </button>
                <a href="{{ url_for('inventory.products') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x"></i> Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- Right Sidebar: Help & Summary -->
    <div class="col-lg-4">
        <div class="card position-sticky mb-4" style="top: 1rem;">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Help
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block"><strong>1. Select a product</strong></small>
                    <small class="text-muted d-block">Choose which product is being received</small>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block"><strong>2. Enter quantity</strong></small>
                    <small class="text-muted d-block">How many units are you receiving</small>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block"><strong>3. Add notes (optional)</strong></small>
                    <small class="text-muted d-block">Reference order/shipment info</small>
                </div>
                <div>
                    <small class="text-muted d-block"><strong>4. Confirm</strong></small>
                    <small class="text-muted d-block">Stock will be updated immediately</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-box-seam"></i> Selected Product
                </h5>
            </div>
            <div class="card-body">
                <div id="summary-empty" class="text-muted text-center py-4">
                    <p class="mb-0">No product selected</p>
                </div>
                <div id="summary-info" style="display: none;">
                    <div class="mb-2">
                        <small class="text-muted">Product Name</small>
                        <p class="mb-0"><strong id="summary-name">—</strong></p>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Current Stock</small>
                        <p class="mb-0"><strong id="summary-stock">—</strong></p>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Quantity to Add</small>
                        <p class="mb-0"><strong id="summary-qty" class="text-success">—</strong></p>
                    </div>
                    <hr>
                    <div>
                        <small class="text-muted">New Total</small>
                        <p class="mb-0"><strong id="summary-total" class="fs-5 text-info">—</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #add-stock-btn:disabled {
        cursor: not-allowed;
        opacity: 0.65;
    }
    @media print {
        .btn, .card-header, form, #product-select-wrapper {
            display: none !important;
        }
        .card {
            border: 1px solid #dee2e6;
            page-break-inside: avoid;
        }
    }
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('stock-in-form');
    const changeBtn = document.getElementById('change-product-btn');
    const cancelChangeBtn = document.getElementById('cancel-change-btn');
    const wrapper = document.getElementById('product-select-wrapper');
    const searchInput = document.getElementById('product-search');
    const searchBtn = document.getElementById('product-search-btn');
    const results = document.getElementById('product-search-results');
    const noResults = document.getElementById('product-search-none');
    const addBtn = document.getElementById('add-stock-btn');
    const qtyInput = document.getElementById('qty-input');
    
    // Get all product data - loaded from hidden data attribute
    let productData = {};
    const productDataStore = document.getElementById('product-data-store');
    if (productDataStore) {
        try {
            const dataAttr = productDataStore.getAttribute('data-products');
            if (dataAttr) {
                const parsedData = JSON.parse(dataAttr);
                if (parsedData.products && Array.isArray(parsedData.products)) {
                    parsedData.products.forEach(function(p) {
                        productData[p.id] = {
                            "name": p.name,
                            "stock": p.stock
                        };
                    });
                }
            }
        } catch(e) {
            console.error('Error parsing product data:', e);
        }
    }

    // Get select element (may not exist if product is already selected)
    const selectEl = form.querySelector('select[name="product_id"]');

    function showChangeWrapper() {
        if (wrapper) {
            wrapper.style.display = 'block';
            if (searchInput) {
                searchInput.focus();
                searchInput.value = '';
                filterResults('');
            }
        }
    }

    function hideChangeWrapper() {
        if (wrapper) {
            wrapper.style.display = 'none';
            if (noResults) noResults.style.display = 'none';
        }
    }

    function filterResults(q) {
        if (!results) return;
        const items = Array.from(results.querySelectorAll('.product-search-item'));
        const term = q.trim().toLowerCase();
        let anyVisible = false;

        items.forEach(li => {
            const name = li.getAttribute('data-name').toLowerCase();
            if (!term || name.includes(term)) {
                li.style.display = '';
                anyVisible = true;
            } else {
                li.style.display = 'none';
            }
        });

        if (noResults) {
            noResults.style.display = anyVisible ? 'none' : 'block';
        }
    }

    function updateSubmitState() {
        const select = form.querySelector('select[name="product_id"]');
        const hidden = form.querySelector('input[name="product_id"][type="hidden"]');
        const hasProduct = (select && select.value) || (hidden && hidden.value);
        const hasQty = qtyInput.value && parseInt(qtyInput.value) > 0;
        addBtn.disabled = !(hasProduct && hasQty);
    }

    function updateSummary() {
        const select = form.querySelector('select[name="product_id"]');
        const hidden = form.querySelector('input[name="product_id"][type="hidden"]');
        const pid = (select && select.value) || (hidden && hidden.value);
        const qty = parseInt(qtyInput.value) || 0;

        const summaryEmpty = document.getElementById('summary-empty');
        const summaryInfo = document.getElementById('summary-info');

        if (pid && productData[pid]) {
            const data = productData[pid];
            summaryEmpty.style.display = 'none';
            summaryInfo.style.display = 'block';
            document.getElementById('summary-name').textContent = data.name;
            document.getElementById('summary-stock').textContent = data.stock + ' units';
            document.getElementById('summary-qty').textContent = qty + ' units';
            document.getElementById('summary-total').textContent = (data.stock + qty) + ' units';
        } else {
            summaryEmpty.style.display = 'block';
            summaryInfo.style.display = 'none';
        }
    }

    // Event listeners for change button
    if (changeBtn && wrapper) {
        changeBtn.addEventListener('click', function(e){
            e.preventDefault();
            showChangeWrapper();
        });
    }

    if (cancelChangeBtn && wrapper) {
        cancelChangeBtn.addEventListener('click', function(e){
            e.preventDefault();
            hideChangeWrapper();
        });
    }

    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function(){
            filterResults(this.value);
        });

        searchInput.addEventListener('keydown', function(e){
            if (e.key === 'Enter') {
                e.preventDefault();
                filterResults(this.value);
            }
        });
    }

    if (searchBtn) {
        searchBtn.addEventListener('click', function(e){
            e.preventDefault();
            filterResults(searchInput ? searchInput.value : '');
        });
    }

    // Product selection from search results
    if (results) {
        Array.from(results.querySelectorAll('.product-search-item')).forEach(li => {
            li.addEventListener('click', function(e){
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');

                // Update or create hidden input
                let hiddenInput = form.querySelector('input[name="product_id"][type="hidden"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'product_id';
                    form.insertBefore(hiddenInput, form.firstChild);
                }
                hiddenInput.value = id;

                // Remove any select element
                const select = form.querySelector('select[name="product_id"]');
                if (select) select.remove();

                // Update selected product panel
                const selectedPanel = document.getElementById('selected-product-panel');
                if (!selectedPanel) {
                    // Create panel if doesn't exist
                    const panel = document.createElement('div');
                    panel.id = 'selected-product-panel';
                    panel.className = 'alert alert-info d-flex align-items-center justify-content-between mb-0';
                    panel.innerHTML = `
                        <div>
                            <h6 class="mb-1"><i class="bi bi-check-circle"></i> <strong>${name}</strong></h6>
                            <small class="text-muted">Current stock: <strong>${productData[id].stock}</strong> units</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="change-product-btn">
                            <i class="bi bi-pencil"></i> Change
                        </button>
                    `;
                    const cardBody = form.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.innerHTML = '';
                        cardBody.appendChild(panel);
                    }
                } else {
                    selectedPanel.querySelector('strong:first-of-type').textContent = name;
                    selectedPanel.querySelector('strong:nth-of-type(2)').textContent = productData[id].stock;
                }

                hideChangeWrapper();
                updateSubmitState();
                updateSummary();
            });
        });
    }

    // Select change listener
    if (selectEl) {
        selectEl.addEventListener('change', function(){
            updateSubmitState();
            updateSummary();
        });
    }

    // Quantity input listener
    qtyInput.addEventListener('input', function(){
        updateSubmitState();
        updateSummary();
    });

    // Initial state
    updateSubmitState();
    updateSummary();
});
</script>
{% endblock %}

{% endblock %}
