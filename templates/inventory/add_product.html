{% extends 'layouts/base.html' %}

{% block title %}{% if product %}Edit Product{% else %}Add Product{% endif %} - Inventory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-2">
            <i class="bi bi-box-seam"></i> {% if product %}Edit Product{% else %}Add Product{% endif %}
        </h1>
        {% if product %}
        <p class="text-muted mb-0">Update product details, pricing, and stock settings</p>
        {% else %}
        <p class="text-muted mb-0">Create a new product and set initial stock levels</p>
        {% endif %}
    </div>
    {% if product %}
    <a href="{{ url_for('inventory.products') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Products
    </a>
    {% endif %}
</div>

<form method="POST" id="product-form">
    <div class="row g-4">
        <!-- Left Column: Main Product Info -->
        <div class="col-lg-8">
            <!-- Product Information Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Product Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Product Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control" required 
                                   value="{{ product.name if product else '' }}"
                                   placeholder="e.g., HP LaserJet Toner Cartridge">
                            <small class="form-text text-muted">Clear, descriptive name for customer-facing displays</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">SKU</label>
                            <input type="text" name="sku" class="form-control" 
                                   value="{{ product.sku if product and product.sku else '' }}"
                                   placeholder="e.g., HP-LJ-4050">
                            <small class="form-text text-muted">Stock Keeping Unit (optional)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Type Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-tag"></i> Product Type & Pricing
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Category <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select name="category_id" class="form-select" id="category-select" required>
                                    <option value="">-- Select a Category --</option>
                                    {% for c in categories %}
                                    <option value="{{ c.id }}" {% if product and product.category_id == c.id %}selected{% endif %}>
                                        {{ c.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="add-category-btn" title="Add a new category">
                                    <i class="bi bi-plus"></i> Add Type
                                </button>
                            </div>
                            <small class="form-text text-muted">Organize products by type. Create new types on-the-fly.</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Sell Price <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">â‚±</span>
                                <input type="number" name="sell_price" class="form-control" step="0.01" min="0" 
                                       value="{{ product.sell_price if product and product.sell_price is not none else '' }}"
                                       placeholder="0.00" required>
                            </div>
                            <small class="form-text text-muted">Selling price per unit</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Rules Section (only on create) -->
            {% if not product %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2"></i> Opening Stock & Reorder Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Opening Stock</label>
                            <input type="number" name="opening_stock" class="form-control" min="0" value="0">
                            <small class="form-text text-muted">Initial quantity in stock</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Reorder Threshold</label>
                            <input type="number" name="reorder_threshold" class="form-control" min="0" value="5">
                            <small class="form-text text-muted">Alert when stock falls below this</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Reorder To</label>
                            <input type="number" name="reorder_to" class="form-control" min="0" value="20">
                            <small class="form-text text-muted">Target quantity when reordering</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Quick Info & Submit -->
        <div class="col-lg-4">
            <div class="card position-sticky" style="top: 1rem;">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="bi bi-question-circle"></i> Help
                    </h6>
                    <ul class="list-unstyled small text-muted">
                        {% if not product %}
                        <li class="mb-2">
                            <strong class="text-dark">Creating a product?</strong><br>
                            Set opening stock and reorder settings to keep inventory managed automatically.
                        </li>
                        {% else %}
                        <li class="mb-2">
                            <strong class="text-dark">Editing a product?</strong><br>
                            Price and category can be updated. Stock is managed separately.
                        </li>
                        {% endif %}
                        <li class="mb-2">
                            <strong class="text-dark">Categories matter.</strong><br>
                            Use clear names to organize products for better reporting.
                        </li>
                        <li>
                            <strong class="text-dark">SKU optional.</strong><br>
                            Use internal or supplier codes for tracking.
                        </li>
                    </ul>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary btn-lg" type="submit">
                            <i class="bi bi-check-circle"></i>
                            {% if product %}Save Changes{% else %}Create Product{% endif %}
                        </button>
                        <a href="{{ url_for('inventory.products') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light border-bottom">
                <h5 class="modal-title" id="addCategoryModalLabel">
                    <i class="bi bi-plus-circle"></i> Create Product Type
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="add-cat-alert" class="alert alert-danger" style="display:none;" role="alert"></div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Type Name <span class="text-danger">*</span></label>
                    <input type="text" id="new-category-name" class="form-control form-control-lg" 
                           placeholder="e.g., Accessories, Chargers, Parts">
                    <small class="form-text text-muted d-block mt-2">
                        Use short, clear names. Examples: Toners, Cables, Batteries, RAM Modules
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="save-category-btn">
                    <i class="bi bi-check"></i> Create Type
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// shared JavaScript for product form
(function(){
    // price input formatting
    const priceInput = document.querySelector('input[name="sell_price"]');
    if (priceInput) {
        priceInput.addEventListener('input', (e)=>{
            let v = e.target.value;
            // allow only numbers and dot
            v = v.replace(/[^0-9.]/g,'');
            // ensure only one dot
            const parts=v.split('.');
            if(parts.length>2) v=parts[0]+'.'+parts.slice(1).join('');
            e.target.value=v;
        });
    }
})();

// category modal & form handling

document.addEventListener('DOMContentLoaded', function(){
    const addBtn = document.getElementById('add-category-btn');
    const modalEl = document.getElementById('addCategoryModal');
    const categorySelect = document.getElementById('category-select');
    const saveBtn = document.getElementById('save-category-btn');
    const nameInput = document.getElementById('new-category-name');
    const alertEl = document.getElementById('add-cat-alert');
    const form = document.getElementById('product-form');

    let bsModal = null;
    if (modalEl && window.bootstrap) {
        bsModal = new bootstrap.Modal(modalEl);
    }

    function showAlert(message) {
        alertEl.textContent = message;
        alertEl.style.display = 'block';
        alertEl.setAttribute('role', 'alert');
    }

    function hideAlert() {
        alertEl.style.display = 'none';
        alertEl.textContent = '';
    }

    if (addBtn && bsModal) {
        addBtn.addEventListener('click', function(e){
            e.preventDefault();
            hideAlert();
            nameInput.value = '';
            // Clear any previous focus states
            alertEl.classList.remove('alert-danger', 'alert-success');
            bsModal.show();
            setTimeout(() => nameInput.focus(), 200);
        });
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', async function(e){
            e.preventDefault();
            hideAlert();
            const name = (nameInput.value || '').trim();
            if (!name) {
                showAlert('Please enter a type name.');
                nameInput.focus();
                return;
            }
            saveBtn.disabled = true;
            try {
                const res = await fetch('/inventory/categories/add_quick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                const json = await res.json();
                if (!json.success) {
                    showAlert(json.message || 'Error adding type.');
                    saveBtn.disabled = false;
                    return;
                }
                const cat = json.category;
                // Add to select
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.name;
                opt.selected = true;
                categorySelect.appendChild(opt);
                // Trigger change event for form validation if needed
                categorySelect.dispatchEvent(new Event('change'));
                bsModal.hide();
                // Reset for next use
                nameInput.value = '';
            } catch (err) {
                console.error('Fetch error:', err);
                showAlert('Error adding type. Please try again.');
                saveBtn.disabled = false;
            }
        });

        // Submit on Enter
        nameInput.addEventListener('keydown', function(e){
            if (e.key === 'Enter' && !saveBtn.disabled) {
                e.preventDefault();
                saveBtn.click();
            }
        });

        // Re-enable button after modal closes
        modalEl.addEventListener('hidden.bs.modal', function(){
            saveBtn.disabled = false;
        });
    }
});
</script>

<style>
    .form-label {
        margin-bottom: 0.5rem;
    }
    .form-text {
        display: block;
        margin-top: 0.25rem;
    }
    @media print {
        .btn, .card-header bg-light, #category-select {
            display: none !important;
        }
    }
</style>

{% endblock %}

{% endblock %}
